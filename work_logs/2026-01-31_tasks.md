# 2026-01-31 작업 로그

## 성능 최적화: Redis 락 경쟁 (Lock Contention)

### 문제점 (Issue)

- **병목 현상**: 좌석 예약 시 높은 동시성 요청으로 인해 Redis에서 병목이 발생함.
- **원인**: 기존 `reserveSeat` 메서드는 캐시가 이미 생성된(warm) 상태일 때도 모든 요청마다 무거운 락 메커니즘(`Redlock`)을 사용함. 이로 인해 '락 획득 -> DB/캐시 확인 -> 캐시 업데이트 -> 락 해제'라는 다수의 네트워크 왕복이 발생함.

### 해결책 (Solution)

**Lua Scripting**을 도입하여 Redis 내부에서 예약 로직을 원자적(Atomic)으로 처리함으로써, "Hot Path"(캐시 히트 상황)에서의 네트워크 오버헤드를 줄이고 명시적인 분산 락 사용을 제거함.

### 기술적 세부사항 (Technical Details)

#### 1. Lua 스크립트 통합 (Hot Path)

다음 작업을 원자적으로 수행하는 Lua 스크립트를 도입함:

1.  **좌석 상태 확인**: Redis에서 좌석 상태가 `AVAILABLE`인지 확인.
2.  **예약 대기열 추가**: 예약 데이터를 큐에 추가 (`rpush`).
3.  **좌석 선점**: 좌석 상태를 `HELD`로 업데이트하고 TTL 설정.

**이점**:

- **원자적 실행**: 스크립트가 Redis 내에서 단일 트랜잭션처럼 실행되므로, 외부 락 없이도 경쟁 상태(Race Condition)를 방지함.
- **지연 시간 감소**: 네트워크 왕복 횟수를 약 5회(Redlock 사이클)에서 **1회**(단일 `eval` 호출)로 단축함.

#### 2. 견고한 폴백 메커니즘 (Cold Path)

안정성을 위해 기존 로직을 폴백(Fallback)으로 유지함:

- Lua 스크립트가 `'MISS'`(키 없음)를 반환하면, 시스템은 기존의 **Redlock -> DB 확인** 흐름으로 전환됨.
- 이를 통해 Redis 캐시가 만료되거나 비어있는 경우(Cold)에도 데이터 정합성을 보장함.

#### 3. 린트(Lint) 및 타입 안전성 수정

- `catch` 블록에서 에러 객체에 대한 안전하지 않은 `any` 접근을 수정함 (`instanceof Error` 체크 추가).
- `reservation.service.ts`의 포맷팅 및 들여쓰기를 정리함.

### 결과 (Result)

- 고동시성 예약 요청에 대한 처리량(Throughput)이 크게 향상될 것으로 예상됨.
- 폴백 메커니즘과 데이터베이스의 낙관적 락(Optimistic Lock)을 통해 엄격한 데이터 정합성을 유지함.

## 성능 최적화: 대량 트래픽 처리를 위한 Bulk Processing 및 Cache Warming

### 배경 (Context)
- 초기 최적화(Lua Script)에도 불구하고, 부하 테스트 시 **Cold Start**(캐시가 빈 상태) 문제로 인해 대다수 요청이 "Slow Path(Redlock)"를 타게 되어 Redis 성능 이점을 온전히 누리지 못함.
- 5만 건 수준의 폭발적 트래픽을 단건 처리하는 구조적 한계.

### 해결책 (Solution)

#### 1. Bulk Processing + In-Memory Buffer
- **구조 변경**: 요청을 즉시 Redis로 보내지 않고, 서버 메모리 상의 `Queue`에 잠시 버퍼링함.
- **파이프라이닝**: 10ms 주기로 큐에 쌓인 요청들(최대 100개)을 **단 한 번의 Redis Pipeline**으로 묶어서 전송.
- **이점**: 네트워크 왕복 횟수를 획기적으로 줄여(1/100 수준), Redis CPU 부하 감소 및 처리량 극대화.

#### 2. Cache Warming (캐시 예열)
- `SeatService.getSeats` 조회 시 DB 데이터를 바탕으로 Redis 캐시(`seat:{id}:status`)를 미리 생성(Warming)하도록 수정.
- 이를 통해 예약 요청 시 "Hot Path(Lua Script)"로 진입할 확률을 100% 가깝게 유지.

#### 3. 버그 수정: 예약 취소 정합성
- `cancelReservation` 시 DB만 업데이트하고 Redis 상태를 롤백하지 않던 문제를 수정.
- 취소 즉시 Redis 상태를 `AVAILABLE`로 변경하여 재예약이 가능하도록 조치.

### 결과 (Result)
- "Total Commands" 수치 대폭 감소 예상.
- 초기 지연(Latency) 없이 안정적인 고성능 처리 가능.
