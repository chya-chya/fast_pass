# 2026-02-05

## Jaeger 트레이스 분석 및 DB 락 최적화

- **문제점 (Issue)**: 예약 처리 과정에서 `Performance` 테이블에 심각한 DB 락 경합(Lock Contention) 발생 확인.
  - `UPDATE "public"."Performance" ...` 쿼리 수행에 무려 1.38초 소요.
  - 원인: 모든 동시 예약 요청이 트랜잭션 내부에서 동일한 `Performance` 행(row)의 `availableSeats`를 업데이트하려고 하여 락 대기 시간 발생.
  - 추가 발견: `ReservationScheduler`가 이전 배치가 완료되기 전에 새로운 배치를 시작하는 실행 중첩(Overlapping) 문제 확인.

- **해결 방안 (Solution)**:
  - **Reservation Service 리팩토링**: `processNextReservation` 및 `cancelReservation` 메서드에서 실시간 `availableSeats` 업데이트 로직을 제거하여 트랜잭션 범위 내의 락 유발 요인을 없앰.
  - **결과적 일관성(Eventual Consistency) 도입**: `ReservationService`에 `syncAvailableSeats` 메서드 구현. `GROUP BY` 쿼리를 사용해 `AVAILABLE` 상태인 좌석 수를 효율적으로 집계하고, `Performance` 테이블에 비동기로 일괄 반영하도록 변경.
  - **스케줄러 개선**:
    - `handleReservationQueue`에 `isProcessing` 플래그를 도입하여 스케줄러 중복 실행 방지.
    - 잔여 좌석 수 동기화를 위해 `syncAvailableSeats`를 5초마다 실행하는 `@Interval(5000)` 작업(`handleSeatSync`) 추가.

- **결과 (Result)**: `Performance` 테이블의 DB 락 병목 현상을 제거하여 처리량(Throughput) 및 동시성 성능 향상. 잔여 좌석 정보는 5초 주기의 결과적 일관성을 갖게 됨.

---
