# 2026-02-05

## Jaeger 트레이스 분석 및 DB 락 최적화

- **문제점 (Issue)**: 예약 처리 과정에서 `Performance` 테이블에 심각한 DB 락 경합(Lock Contention) 발생 확인.
  - `UPDATE "public"."Performance" ...` 쿼리 수행에 무려 1.38초 소요.
  - 원인: 모든 동시 예약 요청이 트랜잭션 내부에서 동일한 `Performance` 행(row)의 `availableSeats`를 업데이트하려고 하여 락 대기 시간 발생.
  - 추가 발견: `ReservationScheduler`가 이전 배치가 완료되기 전에 새로운 배치를 시작하는 실행 중첩(Overlapping) 문제 확인.

- **해결 방안 (Solution)**:
  - **Reservation Service 리팩토링**: `processNextReservation` 및 `cancelReservation` 메서드에서 실시간 `availableSeats` 업데이트 로직을 제거하여 트랜잭션 범위 내의 락 유발 요인을 없앰.
  - **결과적 일관성(Eventual Consistency) 도입**: `ReservationService`에 `syncAvailableSeats` 메서드 구현. `GROUP BY` 쿼리를 사용해 `AVAILABLE` 상태인 좌석 수를 효율적으로 집계하고, `Performance` 테이블에 비동기로 일괄 반영하도록 변경.
  - **스케줄러 개선**:
    - `handleReservationQueue`에 `isProcessing` 플래그를 도입하여 스케줄러 중복 실행 방지.
    - 잔여 좌석 수 동기화를 위해 `syncAvailableSeats`를 5초마다 실행하는 `@Interval(5000)` 작업(`handleSeatSync`) 추가.

- **결과 (Result)**: `Performance` 테이블의 DB 락 병목 현상을 제거하여 처리량(Throughput) 및 동시성 성능 향상. 잔여 좌석 정보는 5초 주기의 결과적 일관성을 갖게 됨.

---

## Trouble Shooting (트러블 슈팅)

### Performance Table DB Lock Contention

**1. 배경 (Context)**

- 대규모 트래픽이 몰리는 ‘선착순 예약’ 로직에 대한 부하 테스트 수행.
- 높은 동시성(Concurrency) 상황에서 예약 성공 및 실패 응답이 지연되는 현상 발생.

**2. 증상 (Symptoms)**

- Jaeger Distributed Tracing 분석 결과, 특정 DB 쿼리에서 비정상적인 Latency(1.38s) 관측.
- 문제의 쿼리: `UPDATE "public"."Performance" SET "availableSeats" ...`
- `ReservationScheduler` 로그에서 처리 속도가 요청 유입 속도를 따라가지 못하는 병목 현상 확인.

**3. 원인 분석 (Root Cause Analysis)**

- **Hot Row Lock**: 예약 성공 시마다 `Performance` 테이블의 `availableSeats` 컬럼을 `-1` 차감하는 로직이 트랜잭션 내에 포함되어 있었음.
- 수천 개의 동시 트랜잭션이 **단 하나의 행(Performance Row)**을 수정하기 위해 배타적 락(Exclusive Lock)을 획득하려고 경쟁.
- 이로 인해 데이터베이스 레벨에서 심각한 줄세우기(Serialization)가 발생하여 전체 트랜잭션 시간이 길어짐.

**4. 해결 및 결과 (Resolution & Optimization)**

- **Lock 분리**: 트랜잭션 내에서 `Seat` 상태 변경과 `Reservation` 생성만 수행하고, `Performance` 테이블 업데이트는 트랜잭션에서 제거.
- **Eventual Consistency (결과적 일관성)**:
  - 정확한 잔여 좌석 수는 실시간 트랜잭션이 아닌, `GROUP BY` 쿼리를 통해 주기적(5초)으로 재계산하여 업데이트하는 방식으로 변경.
  - 사용자는 최대 5초 전의 잔여 좌석 정보를 볼 수 있지만, 실제 예약 시도 시에는 `Seat` 테이블의 락을 통해 정합성이 보장되므로 초과 예약 문제는 없음.
- **결과**:
  - `Performance` 테이블 락 경합 완전 해소.
  - 예약 트랜잭션 처리 속도 비약적 향상.
